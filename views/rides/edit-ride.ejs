<%- include('../partials/header') %>

<div class="pt-20 pb-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 max-w-4xl">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-700 rounded-2xl shadow-lg p-8 mb-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-edit mr-3"></i>Edit Ride
                    </h1>
                    <p class="opacity-90">Update your ride details</p>
                </div>
                <a href="/rides/my-rides" class="bg-white text-blue-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </a>
            </div>
        </div>

        <!-- Edit Form -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <form id="editRideForm" class="space-y-6">
                <!-- Current Route (Read-only) -->
                <div class="bg-blue-50 rounded-lg p-6 border-l-4 border-blue-500">
                    <h3 class="font-bold text-gray-800 mb-3">
                        <i class="fas fa-route text-blue-600 mr-2"></i>Current Route
                    </h3>
                    <div class="space-y-2">
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-map-marker-alt text-green-600 w-6"></i>
                            <span class="ml-2"><%= (ride.route && ride.route.start) ? (ride.route.start.name || ride.route.start.address) : 'N/A' %></span>
                        </div>
                        <div class="flex items-center text-gray-400 ml-6">
                            <i class="fas fa-arrow-down"></i>
                            <span class="ml-3 text-sm">
                                <%= (ride.route && ride.route.distance) ? ride.route.distance.toFixed(1) + ' km' : 'N/A' %>
                            </span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-map-marker-alt text-red-600 w-6"></i>
                            <span class="ml-2"><%= (ride.route && ride.route.destination) ? (ride.route.destination.name || ride.route.destination.address) : 'N/A' %></span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">
                        <i class="fas fa-info-circle mr-1"></i>Route cannot be changed after posting
                    </p>
                </div>

                <!-- Date & Time -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-calendar-alt text-primary mr-2"></i>Date & Time
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Departure Date *</label>
                            <input type="date" 
                                id="editDate" 
                                name="date" 
                                value="<%= new Date(ride.schedule.departureDateTime).toISOString().split('T')[0] %>"
                                min="<%= new Date().toISOString().split('T')[0] %>"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Departure Time *</label>
                            <input type="time" 
                                id="editTime" 
                                name="time"
                                value="<%= ride.schedule.time || new Date(ride.schedule.departureDateTime).toTimeString().split(' ')[0].slice(0,5) %>"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required>
                        </div>
                    </div>
                </div>

                <!-- Vehicle & Capacity -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-car text-primary mr-2"></i>Capacity
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Current Vehicle (Read-only) -->
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Current Vehicle</label>
                            <div class="px-4 py-3 border border-gray-200 rounded-lg bg-gray-50">
                                <% 
                                const vehicleInfo = (ride.rider && ride.rider.vehicles) ? ride.rider.vehicles.find(v => v._id.toString() === ride.vehicle.toString()) : null;
                                %>
                                <% if (vehicleInfo) { %>
                                    <i class="fas fa-car text-primary mr-2"></i>
                                    <%= vehicleInfo.make %> <%= vehicleInfo.model %>
                                    <span class="text-gray-500 text-sm ml-2">(<%= vehicleInfo.licensePlate %>)</span>
                                <% } else { %>
                                    <i class="fas fa-car text-gray-400 mr-2"></i>
                                    <span class="text-gray-500">Vehicle info unavailable</span>
                                <% } %>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Vehicle cannot be changed</p>
                        </div>

                        <!-- Available Seats -->
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Available Seats *</label>
                            <select id="editSeats" 
                                name="availableSeats"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required>
                                <% for (let i = 1; i <= 4; i++) { %>
                                    <option value="<%= i %>" <%= (ride.pricing && ride.pricing.availableSeats === i) ? 'selected' : '' %>>
                                        <%= i %> seat<%= i > 1 ? 's' : '' %>
                                    </option>
                                <% } %>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                Currently: <%= (ride.pricing && ride.pricing.availableSeats) ? ride.pricing.availableSeats : 0 %> available
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-rupee-sign text-primary mr-2"></i>Pricing
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Price per Seat *</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-500">₹</span>
                                <input type="number" 
                                    id="editPrice" 
                                    name="pricePerSeat" 
                                    value="<%= (ride.pricing && ride.pricing.pricePerSeat) ? ride.pricing.pricePerSeat : 0 %>"
                                    min="10" 
                                    step="10"
                                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">Suggested: ₹8-15 per km</p>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Total Distance</label>
                            <div class="px-4 py-3 border border-gray-200 rounded-lg bg-gray-50">
                                <i class="fas fa-road text-primary mr-2"></i>
                                <%= (ride.route && ride.route.distance) ? ride.route.distance.toFixed(1) + ' km' : 'N/A' %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-sliders-h text-primary mr-2"></i>Preferences
                    </h2>

                    <div class="space-y-4">
                        <!-- Auto-Approve -->
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <h4 class="font-semibold text-gray-800">
                                    <i class="fas fa-bolt text-blue-600 mr-1"></i>Auto-Approve Bookings
                                </h4>
                                <p class="text-sm text-gray-600">Passengers can book without waiting for approval</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" 
                                    name="instantBooking" 
                                    class="sr-only peer" 
                                    <%= (ride.preferences && ride.preferences.autoAcceptBookings) ? 'checked' : '' %>>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>

                        <!-- Ladies Only (Only for Female Riders) -->
                        <% if (user.gender === 'FEMALE') { %>
                        <div class="flex items-center justify-between p-4 bg-pink-50 rounded-lg border border-pink-200">
                            <div>
                                <h4 class="font-semibold text-gray-800">
                                    <i class="fas fa-female text-pink-600 mr-1"></i>Ladies Only
                                </h4>
                                <p class="text-sm text-gray-600">Only female passengers can book this ride</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" 
                                    name="ladiesOnly" 
                                    class="sr-only peer"
                                    <%= (ride.preferences && ride.preferences.gender === 'FEMALE_ONLY') ? 'checked' : '' %>>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500">
                                </div>
                            </label>
                        </div>
                        <% } %>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-6">
                    <button type="submit" 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <a href="/rides/my-rides" 
                        class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition">
                        Cancel
                    </a>
                </div>
            </form>

            <!-- Success/Error Messages -->
            <div id="editMessage" class="mt-4 hidden"></div>
        </div>
    </div>
</div>

<script>
document.getElementById('editRideForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const messageDiv = document.getElementById('editMessage');
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    
    try {
        // Combine date and time
        const date = document.getElementById('editDate').value;
        const time = document.getElementById('editTime').value;
        const departureDateTime = new Date(`${date}T${time}`).toISOString();
        
        const response = await fetch('/rides/<%= ride._id %>', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                departureTime: departureDateTime,
                availableSeats: document.getElementById('editSeats').value,
                pricePerSeat: document.getElementById('editPrice').value,
                preferences: JSON.stringify({
                    autoAcceptBookings: document.querySelector('input[name="instantBooking"]').checked,
                    gender: document.querySelector('input[name="ladiesOnly"]') && document.querySelector('input[name="ladiesOnly"]').checked ? 'FEMALE_ONLY' : 'ANY'
                })
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageDiv.className = 'mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg';
            messageDiv.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>${data.message}
            `;
            messageDiv.classList.remove('hidden');
            
            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = '/rides/my-rides';
            }, 2000);
        } else {
            throw new Error(data.message || 'Failed to update ride');
        }
    } catch (error) {
        console.error('Error:', error);
        messageDiv.className = 'mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg';
        messageDiv.innerHTML = `
            <i class="fas fa-exclamation-circle mr-2"></i>${error.message}
        `;
        messageDiv.classList.remove('hidden');
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
    }
});
</script>

<%- include('../partials/footer') %>
