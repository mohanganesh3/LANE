<%- include('../partials/header') %>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    .car-marker {
        font-size: 32px;
        color: #6366f1;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .route-info-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .status-live {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-ended {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .pulse-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        margin-right: 6px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .map-container {
        height: 500px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .info-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    
    .info-icon {
        width: 40px;
        height: 40px;
        background: #6366f1;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }
</style>

<div class="pt-16 min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="route-info-card">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <a href="/bookings/my-bookings" class="text-gray-600 hover:text-primary mr-4">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-route text-primary mr-2"></i>
                            Track Ride
                        </h1>
                        <p class="text-gray-600 text-sm mt-1">
                            <%= ride.route?.start?.name || ride.fromLocation %> → <%= ride.route?.destination?.name || ride.toLocation %>
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <% 
                    const isActive = ride.status === 'ACTIVE' || ride.status === 'IN_PROGRESS';
                    %>
                    <span class="status-badge <%= isActive ? 'status-live' : 'status-ended' %>">
                        <% if (isActive) { %>
                            <span class="pulse-dot"></span>
                            Ride In Progress
                        <% } else { %>
                            <i class="fas fa-check-circle mr-2"></i>
                            <%= ride.status %>
                        <% } %>
                    </span>
                </div>
            </div>

            <!-- Driver & Vehicle Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden mr-3">
                        <img src="<%= ride.rider?.profile?.photo || '/images/default-avatar.png' %>" 
                             alt="<%= ride.rider?.profile?.firstName %>"
                             class="w-full h-full object-cover">
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Driver</p>
                        <p class="font-semibold text-gray-800">
                            <%= ride.rider?.profile?.firstName %> <%= ride.rider?.profile?.lastName %>
                        </p>
                        <div class="flex items-center text-xs text-yellow-500">
                            <i class="fas fa-star mr-1"></i>
                            <span><%= (ride.rider?.rating?.overall || 5.0).toFixed(1) %></span>
                        </div>
                    </div>
                </div>

                <% if (ride.vehicle) { %>
                <div class="flex items-center">
                    <i class="fas fa-car text-primary text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">Vehicle</p>
                        <p class="font-semibold text-gray-800"><%= ride.vehicle.make %> <%= ride.vehicle.model %></p>
                        <p class="text-xs text-gray-600"><%= ride.vehicle.licensePlate %></p>
                    </div>
                </div>
                <% } %>

                <div class="flex items-center">
                    <i class="fas fa-clock text-primary text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">Departure</p>
                        <p class="font-semibold text-gray-800">
                            <%= ride.schedule?.departureDateTime ? new Date(ride.schedule.departureDateTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : 'N/A' %>
                        </p>
                        <p class="text-xs text-gray-600">
                            <%= ride.schedule?.departureDateTime ? new Date(ride.schedule.departureDateTime).toLocaleDateString() : '' %>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Map Container -->
            <div class="lg:col-span-2">
                <div class="map-container">
                    <div id="map" class="w-full h-full"></div>
                </div>

                <!-- Route Info -->
                <div class="route-info-card mt-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-info-circle text-primary mr-2"></i>
                        Route Information
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-road"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Distance</p>
                                <p class="font-semibold text-gray-800">
                                    <%= ride.route?.distance ? ride.route.distance.toFixed(1) : '0' %> km
                                </p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Duration</p>
                                <p class="font-semibold text-gray-800">
                                    <%= ride.route?.duration ? Math.round(ride.route.duration) : '0' %> mins
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <!-- Contact Driver -->
                <div class="route-info-card">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-phone text-primary mr-2"></i>
                        Contact Driver
                    </h3>
                    <button onclick="window.location.href='tel:<%= ride.rider?.phone || '' %>'" 
                            class="w-full bg-primary hover:bg-primary-dark text-white py-3 rounded-lg font-semibold transition mb-3">
                        <i class="fas fa-phone-alt mr-2"></i>
                        Call Driver
                    </button>
                    <button onclick="window.location.href='/chat/<%= booking?._id || '' %>'" 
                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-comment mr-2"></i>
                        Send Message
                    </button>
                </div>

                <!-- Pickup/Drop Points -->
                <div class="route-info-card">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-map-pin text-primary mr-2"></i>
                        Your Journey
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3 flex-shrink-0">
                                <i class="fas fa-circle text-green-600 text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs text-gray-600 mb-1">Pickup</p>
                                <p class="text-sm font-semibold text-gray-800">
                                    <%= booking?.pickup?.name || ride.route?.start?.name || 'Pickup Location' %>
                                </p>
                            </div>
                        </div>

                        <div class="border-l-2 border-dashed border-gray-300 ml-4 h-8"></div>

                        <div class="flex items-start">
                            <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center mr-3 flex-shrink-0">
                                <i class="fas fa-map-marker-alt text-red-600 text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs text-gray-600 mb-1">Drop-off</p>
                                <p class="text-sm font-semibold text-gray-800">
                                    <%= booking?.dropoff?.name || ride.route?.destination?.name || 'Drop Location' %>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Map initialization
const map = L.map('map');

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Get coordinates from server data
const startCoords = <%- JSON.stringify(ride.route?.start?.coordinates || [0, 0]) %>;
const destCoords = <%- JSON.stringify(ride.route?.destination?.coordinates || [0, 0]) %>;
const routeGeometry = <%- JSON.stringify(ride.route?.geometry?.coordinates || []) %>;

console.log('📍 Start:', startCoords);
console.log('📍 Destination:', destCoords);
console.log('🗺️ Route geometry points:', routeGeometry.length);

// Convert [lng, lat] to [lat, lng] for Leaflet
const startLatLng = [startCoords[1], startCoords[0]];
const destLatLng = [destCoords[1], destCoords[0]];

// Add start marker (Green)
const startIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

const startMarker = L.marker(startLatLng, { icon: startIcon }).addTo(map);
startMarker.bindPopup(`<b>🟢 Start</b><br>${'<%= ride.route?.start?.name || "Start Location" %>'}`);

// Add destination marker (Red)
const destIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

const destMarker = L.marker(destLatLng, { icon: destIcon }).addTo(map);
destMarker.bindPopup(`<b>🔴 Destination</b><br>${'<%= ride.route?.destination?.name || "Destination" %>'}`);

// Draw route if geometry exists
if (routeGeometry && routeGeometry.length > 0) {
    // Convert [lng, lat] to [lat, lng] for Leaflet
    const routePath = routeGeometry.map(coord => [coord[1], coord[0]]);
    
    const routeLine = L.polyline(routePath, {
        color: '#6366f1',
        weight: 5,
        opacity: 0.7,
        smoothFactor: 1
    }).addTo(map);
    
    // Add car icon in the middle of the route (approximate current location)
    const midIndex = Math.floor(routePath.length / 2);
    const carPosition = routePath[midIndex];
    
    const carIcon = L.divIcon({
        className: 'car-marker',
        html: '<i class="fas fa-car"></i>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
    
    const carMarker = L.marker(carPosition, { icon: carIcon }).addTo(map);
    carMarker.bindPopup('<b>🚗 Driver Location</b><br>Approximate position');
    
    // Fit map to show entire route
    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
} else {
    // If no route geometry, draw straight line and fit to markers
    const straightLine = L.polyline([startLatLng, destLatLng], {
        color: '#6366f1',
        weight: 3,
        opacity: 0.5,
        dashArray: '10, 10'
    }).addTo(map);
    
    // Add car icon in the middle
    const midLat = (startLatLng[0] + destLatLng[0]) / 2;
    const midLng = (startLatLng[1] + destLatLng[1]) / 2;
    
    const carIcon = L.divIcon({
        className: 'car-marker',
        html: '<i class="fas fa-car"></i>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
    
    const carMarker = L.marker([midLat, midLng], { icon: carIcon }).addTo(map);
    carMarker.bindPopup('<b>🚗 Driver</b><br>On the way');
    
    map.fitBounds([startLatLng, destLatLng], { padding: [80, 80] });
}

// Add zoom controls
L.control.zoom({ position: 'topright' }).addTo(map);

console.log('✅ Static route map loaded successfully');
</script>

<%- include('../partials/footer') %>
