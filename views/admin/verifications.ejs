<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - LANE Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
        }

        .admin-content {
            padding: 30px;
        }

        .verification-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }

        .verification-card:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .verification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info-inline {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-details {
            flex: 1;
        }

        .user-name-large {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        .user-meta-inline {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
            margin-top: 5px;
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .document-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-item:hover {
            border-color: #6366f1;
            background: #f9fafb;
        }

        .document-icon {
            font-size: 40px;
            color: #6366f1;
            margin-bottom: 10px;
        }

        .document-name {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .verification-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-view {
            background: #6366f1;
            color: white;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 64px;
            color: #d1d5db;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .document-viewer {
            text-align: center;
        }

        .document-viewer img {
            max-width: 100%;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <%- include('../partials/admin-sidebar.ejs', {active: 'verifications'}) %>

    <div class="admin-main">
        <%- include('../partials/admin-header.ejs', {title: 'Driver Verifications', user}) %>

        <div class="admin-content">
            <% if (requests && requests.length > 0) { %>
                <% requests.forEach(request => { %>
                    <div class="verification-card" data-user-id="<%= request._id %>">
                        <div class="verification-header">
                            <div class="user-info-inline">
                                <img src="<%= request.profile.photo || '/images/default-avatar.png' %>" 
                                     alt="<%= request.profile.firstName %>" 
                                     class="user-avatar-small">
                                <div class="user-details">
                                    <div class="user-name-large">
                                        <%= request.profile.firstName %> <%= request.profile.lastName %>
                                    </div>
                                    <div class="user-meta-inline">
                                        <span><i class="fas fa-envelope"></i> <%= request.email %></span>
                                        <span><i class="fas fa-phone"></i> <%= request.phone %></span>
                                        <span><i class="fas fa-calendar"></i> Applied <%= new Date(request.createdAt).toLocaleDateString() %></span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <span class="badge badge-warning">
                                    <i class="fas fa-clock"></i> Pending Review
                                </span>
                            </div>
                        </div>

                        <!-- Documents Grid -->
                        <div class="documents-grid">
                            <% if (request.documents.drivingLicense) { %>
                                <div class="document-item" onclick="viewDocument('<%= request.documents.drivingLicense.url %>', 'Driving License')">
                                    <i class="fas fa-id-card document-icon"></i>
                                    <div class="document-name">Driving License</div>
                                </div>
                            <% } %>
                            
                            <% if (request.documents.aadharCard) { %>
                                <div class="document-item" onclick="viewDocument('<%= request.documents.aadharCard.url %>', 'Aadhar Card')">
                                    <i class="fas fa-id-badge document-icon"></i>
                                    <div class="document-name">Aadhar Card</div>
                                </div>
                            <% } %>
                            
                            <% if (request.documents.vehicleRC) { %>
                                <div class="document-item" onclick="viewDocument('<%= request.documents.vehicleRC.url %>', 'Vehicle RC')">
                                    <i class="fas fa-file-alt document-icon"></i>
                                    <div class="document-name">Vehicle RC</div>
                                </div>
                            <% } %>
                            
                            <% if (request.documents.vehicleInsurance) { %>
                                <div class="document-item" onclick="viewDocument('<%= request.documents.vehicleInsurance.url %>', 'Insurance')">
                                    <i class="fas fa-shield-alt document-icon"></i>
                                    <div class="document-name">Insurance</div>
                                </div>
                            <% } %>
                        </div>

                        <!-- Vehicle Information -->
                        <% if (request.vehicles && request.vehicles.length > 0) { %>
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <h4 style="margin-bottom: 10px; color: #374151;">
                                    <i class="fas fa-car"></i> Vehicle Details
                                </h4>
                                <% request.vehicles.forEach(vehicle => { %>
                                    <div style="margin-bottom: 8px; color: #6b7280;">
                                        <strong><%= vehicle.make %> <%= vehicle.model %></strong> 
                                        (<%= vehicle.year %>) - 
                                        <%= vehicle.registrationNumber %> - 
                                        <%= vehicle.seats %> seats
                                    </div>
                                <% }); %>
                            </div>
                        <% } %>

                        <!-- Actions -->
                        <div class="verification-actions">
                            <button class="btn btn-view" onclick="viewFullDetails('<%= request._id %>')">
                                <i class="fas fa-eye"></i> View Full Details
                            </button>
                            <button class="btn btn-success" onclick="approveVerificationXHR('<%= request._id %>')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger" onclick="rejectVerificationXHR('<%= request._id %>')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                <% }); %>

                <!-- Pagination -->
                <% if (pagination.pages > 1) { %>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 30px;">
                        <% for (let i = 1; i <= pagination.pages; i++) { %>
                            <a href="?page=<%= i %>" class="btn <%= i === pagination.page ? 'btn-primary' : '' %>">
                                <%= i %>
                            </a>
                        <% } %>
                    </div>
                <% } %>
            <% } else { %>
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h3 style="font-size: 24px; margin-bottom: 10px;">No Pending Verifications</h3>
                    <p>All driver verification requests have been processed.</p>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="documentTitle" style="color: #1f2937;">Document Preview</h2>
                <span onclick="closeModal()" style="font-size: 28px; cursor: pointer; color: #6b7280;">&times;</span>
            </div>
            <div class="document-viewer" id="documentViewer">
                <!-- Document content loaded here -->
            </div>
        </div>
    </div>

    <script>
        // View Document
        function viewDocument(url, name) {
            const modal = document.getElementById('documentModal');
            const title = document.getElementById('documentTitle');
            const viewer = document.getElementById('documentViewer');
            
            title.textContent = name;
            viewer.innerHTML = `<img src="${url}" alt="${name}">`;
            
            modal.classList.add('active');
        }

        // View Full Details
        function viewFullDetails(userId) {
            window.location.href = `/admin/verifications/${userId}`;
        }

        // Approve Verification (XHR)
        function approveVerificationXHR(userId) {
            if (!confirm('Are you sure you want to APPROVE this driver verification?')) return;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', `/admin/verifications/${userId}/approve`, true);
            xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            xhr.onload = function () {
                try {
                    const res = JSON.parse(xhr.responseText);
                    if (xhr.status >= 200 && xhr.status < 300 && res.success) {
                        alert('✅ Driver verification approved successfully!');
                        const card = document.querySelector(`[data-user-id="${userId}"]`);
                        if (card) card.remove();
                    } else {
                        alert('❌ Error: ' + (res.message || 'Failed to approve'));
                    }
                } catch (err) {
                    alert('❌ Invalid server response');
                }
            };

            xhr.onerror = function () {
                alert('❌ Error approving verification');
            };

            xhr.send(JSON.stringify({}));
        }

        // Reject Verification (XHR)
        function rejectVerificationXHR(userId) {
            const reason = prompt('Enter reason for rejection:');
            if (!reason) return;

            if (!confirm('Are you sure you want to REJECT this driver verification?')) return;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', `/admin/verifications/${userId}/reject`, true);
            xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            xhr.onload = function () {
                try {
                    const res = JSON.parse(xhr.responseText);
                    if (xhr.status >= 200 && xhr.status < 300 && res.success) {
                        alert('✅ Driver verification rejected');
                        const card = document.querySelector(`[data-user-id="${userId}"]`);
                        if (card) card.remove();
                    } else {
                        alert('❌ Error: ' + (res.message || 'Failed to reject'));
                    }
                } catch (err) {
                    alert('❌ Invalid server response');
                }
            };

            xhr.onerror = function () {
                alert('❌ Error rejecting verification');
            };

            xhr.send(JSON.stringify({ reason }));
        }

        // Close Modal
        function closeModal() {
            document.getElementById('documentModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('documentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
