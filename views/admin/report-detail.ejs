<%- include('../partials/header') %>

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8">
    <div class="container mx-auto px-4">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="/admin/reports" class="inline-flex items-center text-red-600 hover:text-red-700 font-semibold">
                <i class="fas fa-arrow-left mr-2"></i>Back to Reports
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Report Header -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                                <%= report.category.replace(/_/g, ' ') %>
                            </h1>
                            <p class="text-gray-500 text-sm">
                                Report ID: <span class="font-mono"><%= report._id %></span>
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <% if (report.severity === 'HIGH') { %>
                                <span class="px-4 py-2 bg-red-100 text-red-800 rounded-lg font-semibold">
                                    <i class="fas fa-exclamation-circle mr-1"></i>High Priority
                                </span>
                            <% } else if (report.severity === 'MEDIUM') { %>
                                <span class="px-4 py-2 bg-orange-100 text-orange-800 rounded-lg font-semibold">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>Medium Priority
                                </span>
                            <% } else { %>
                                <span class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg font-semibold">
                                    <i class="fas fa-info-circle mr-1"></i>Low Priority
                                </span>
                            <% } %>
                        </div>
                    </div>

                    <!-- Status Badge -->
                    <% if (report.status === 'PENDING') { %>
                        <div class="inline-flex items-center px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg font-semibold mb-4">
                            <i class="fas fa-clock mr-2"></i>Pending Review
                        </div>
                    <% } else if (report.status === 'UNDER_REVIEW') { %>
                        <div class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 rounded-lg font-semibold mb-4">
                            <i class="fas fa-eye mr-2"></i>Under Review
                        </div>
                    <% } else if (report.status === 'RESOLVED') { %>
                        <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg font-semibold mb-4">
                            <i class="fas fa-check-circle mr-2"></i>Resolved
                        </div>
                    <% } else if (report.status === 'DISMISSED') { %>
                        <div class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-800 rounded-lg font-semibold mb-4">
                            <i class="fas fa-times-circle mr-2"></i>Dismissed
                        </div>
                    <% } else { %>
                        <div class="inline-flex items-center px-4 py-2 bg-red-100 text-red-800 rounded-lg font-semibold mb-4">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Escalated
                        </div>
                    <% } %>

                    <!-- Report Description -->
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Description</h3>
                        <p class="text-gray-600 leading-relaxed"><%= report.description %></p>
                    </div>
                </div>

                <!-- Involved Parties -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Involved Parties</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Reporter -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-semibold text-gray-500 uppercase">Reporter</span>
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">
                                    <%= report.reporter.role %>
                                </span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <img src="<%= report.reporter.profilePhoto || '/images/default-avatar.png' %>" 
                                    class="w-12 h-12 rounded-full" alt="Reporter">
                                <div>
                                    <h4 class="font-semibold text-gray-900">
                                        <%= report.reporter.name || (report.reporter.profile ? report.reporter.profile.firstName + ' ' + report.reporter.profile.lastName : 'User') %>
                                    </h4>
                                    <p class="text-sm text-gray-500"><%= report.reporter.email %></p>
                                    <p class="text-sm text-gray-500"><%= report.reporter.phoneNumber %></p>
                                </div>
                            </div>
                            <a href="/admin/users/<%= report.reporter._id %>" 
                                class="mt-3 inline-flex items-center text-sm text-red-600 hover:text-red-700 font-semibold">
                                <i class="fas fa-user mr-1"></i>View Profile
                            </a>
                        </div>

                        <!-- Reported User -->
                        <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-semibold text-red-600 uppercase">Reported User</span>
                                <span class="px-3 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">
                                    <%= report.reportedUser.role %>
                                </span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <img src="<%= report.reportedUser.profilePhoto || '/images/default-avatar.png' %>" 
                                    class="w-12 h-12 rounded-full" alt="Reported">
                                <div>
                                    <h4 class="font-semibold text-gray-900">
                                        <%= report.reportedUser.name || (report.reportedUser.profile ? report.reportedUser.profile.firstName + ' ' + report.reportedUser.profile.lastName : 'User') %>
                                    </h4>
                                    <p class="text-sm text-gray-600"><%= report.reportedUser.email %></p>
                                    <p class="text-sm text-gray-600"><%= report.reportedUser.phoneNumber %></p>
                                </div>
                            </div>
                            <a href="/admin/users/<%= report.reportedUser._id %>" 
                                class="mt-3 inline-flex items-center text-sm text-red-600 hover:text-red-700 font-semibold">
                                <i class="fas fa-user mr-1"></i>View Profile
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Related Booking/Ride -->
                <% if (report.booking || report.ride) { %>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Related Trip</h2>
                        
                        <% if (report.booking) { %>
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-gray-800">Booking Details</h3>
                                    <span class="text-sm text-gray-500">
                                        ID: <%= report.booking._id.toString().substring(0, 12) %>...
                                    </span>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-map-marker-alt text-green-500 mr-2"></i>
                                        <strong>Pickup:</strong> <%= report.booking.pickupLocation?.address || 'N/A' %>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                                        <strong>Dropoff:</strong> <%= report.booking.dropoffLocation?.address || 'N/A' %>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-rupee-sign text-gray-500 mr-2"></i>
                                        <strong>Amount:</strong> â‚¹<%= report.booking.pricing?.totalAmount || 0 %>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-info-circle text-gray-500 mr-2"></i>
                                        <strong>Status:</strong> <%= report.booking.status %>
                                    </p>
                                </div>
                                <a href="/admin/bookings/<%= report.booking._id %>" 
                                    class="mt-3 inline-flex items-center text-sm text-red-600 hover:text-red-700 font-semibold">
                                    <i class="fas fa-external-link-alt mr-1"></i>View Booking
                                </a>
                            </div>
                        <% } else if (report.ride) { %>
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-gray-800">Ride Details</h3>
                                    <span class="text-sm text-gray-500">
                                        ID: <%= report.ride._id.toString().substring(0, 12) %>...
                                    </span>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-map-marker-alt text-green-500 mr-2"></i>
                                        <strong>From:</strong> <%= report.ride.route?.start?.address || 'N/A' %>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                                        <strong>To:</strong> <%= report.ride.route?.destination?.address || 'N/A' %>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-users text-gray-500 mr-2"></i>
                                        <strong>Seats:</strong> <%= report.ride.seats?.available || 0 %> available
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-info-circle text-gray-500 mr-2"></i>
                                        <strong>Status:</strong> <%= report.ride.status %>
                                    </p>
                                </div>
                                <a href="/admin/rides/<%= report.ride._id %>" 
                                    class="mt-3 inline-flex items-center text-sm text-red-600 hover:text-red-700 font-semibold">
                                    <i class="fas fa-external-link-alt mr-1"></i>View Ride
                                </a>
                            </div>
                        <% } %>
                    </div>
                <% } %>

                <!-- Evidence -->
                <% if (report.evidence && report.evidence.length > 0) { %>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Evidence</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <% report.evidence.forEach(url => { %>
                                <div class="relative group">
                                    <img src="<%= url %>" 
                                        class="w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-90 transition"
                                        onclick="openLightbox('<%= url %>')" 
                                        alt="Evidence">
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-lg transition flex items-center justify-center">
                                        <i class="fas fa-search-plus text-white text-2xl opacity-0 group-hover:opacity-100 transition"></i>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <!-- Admin Review History -->
                <% if (report.adminReview && report.adminReview.reviewedBy) { %>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Admin Review</h2>
                        <div class="border-l-4 border-red-500 pl-4">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-500">
                                    Reviewed by: <span class="font-semibold text-gray-800"><%= report.adminReview.reviewedBy.profile?.firstName || 'Admin' %></span>
                                </p>
                                <p class="text-sm text-gray-500">
                                    <%= new Date(report.adminReview.reviewedAt).toLocaleString() %>
                                </p>
                            </div>
                            <p class="text-sm font-semibold text-gray-800 mb-1">
                                Action: <span class="text-red-600"><%= report.adminReview.action %></span>
                            </p>
                            <% if (report.adminReview.actionDetails) { %>
                                <p class="text-gray-600 mt-2"><%= report.adminReview.actionDetails %></p>
                            <% } else if (report.adminReview.notes) { %>
                                <p class="text-gray-600 mt-2"><%= report.adminReview.notes %></p>
                            <% } %>
                        </div>
                    </div>
                <% } %>
            </div>

            <!-- Admin Actions Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Admin Actions</h2>
                    
                    <% if (report.status === 'PENDING' || report.status === 'UNDER_REVIEW') { %>
                        <!-- Change Status -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Update Status</label>
                            <select id="newStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="UNDER_REVIEW" <%= report.status === 'UNDER_REVIEW' ? 'selected' : '' %>>Under Review</option>
                                <option value="RESOLVED">Resolved</option>
                                <option value="DISMISSED">Dismissed</option>
                                <option value="ESCALATED">Escalated</option>
                            </select>
                        </div>

                        <!-- Action Type -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Action Type</label>
                            <select id="actionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="">Select Action</option>
                                <option value="WARNING">Issue Warning</option>
                                <option value="SUSPENSION">Suspend User</option>
                                <option value="BAN">Ban User</option>
                                <option value="REFUND">Process Refund</option>
                                <option value="NO_ACTION">No Action Required</option>
                            </select>
                        </div>

                        <!-- Suspension Duration (shown when SUSPENSION selected) -->
                        <div id="suspensionDuration" class="mb-6 hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Suspension Duration</label>
                            <select id="duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="1">1 Day</option>
                                <option value="3">3 Days</option>
                                <option value="7">7 Days</option>
                                <option value="14">14 Days</option>
                                <option value="30">30 Days</option>
                            </select>
                        </div>

                        <!-- Admin Notes -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Admin Notes</label>
                            <textarea id="adminNotes" rows="4" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                placeholder="Add notes about your decision..."></textarea>
                        </div>

                        <!-- Submit Button -->
                        <button onclick="submitReview()" 
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition">
                            <i class="fas fa-check mr-2"></i>Submit Review
                        </button>

                        <!-- Quick Actions -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Quick Actions</p>
                            <div class="space-y-2">
                                <button onclick="viewUserHistory('<%= report.reportedUser._id %>')" 
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition">
                                    <i class="fas fa-history mr-2"></i>View User History
                                </button>
                                <button onclick="contactReporter()" 
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition">
                                    <i class="fas fa-envelope mr-2"></i>Contact Reporter
                                </button>
                                <button onclick="contactReported()" 
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition">
                                    <i class="fas fa-envelope mr-2"></i>Contact Reported User
                                </button>
                            </div>
                        </div>
                    <% } else { %>
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                            <p class="text-gray-600 font-semibold">This report has been <%= report.status.toLowerCase() %></p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center" onclick="closeLightbox()">
    <img id="lightboxImg" src="" class="max-w-full max-h-full" alt="Evidence">
    <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300">
        <i class="fas fa-times"></i>
    </button>
</div>

<script>
    // Show/hide suspension duration field
    document.getElementById('actionType').addEventListener('change', function() {
        const suspensionDiv = document.getElementById('suspensionDuration');
        if (this.value === 'SUSPENSION') {
            suspensionDiv.classList.remove('hidden');
        } else {
            suspensionDiv.classList.add('hidden');
        }
    });

    async function submitReview() {
        const status = document.getElementById('newStatus').value;
        const actionType = document.getElementById('actionType').value;
        const notes = document.getElementById('adminNotes').value;
        const duration = document.getElementById('duration').value;

        if (!actionType) {
            alert('Please select an action type');
            return;
        }

        if (!notes.trim()) {
            if (!confirm('Are you sure you want to proceed without adding notes?')) {
                return;
            }
        }

        try {
            const response = await fetch('/admin/reports/<%= report._id %>/review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status,
                    actionType,
                    notes,
                    suspensionDuration: actionType === 'SUSPENSION' ? parseInt(duration) : undefined
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Review submitted successfully');
                window.location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to submit review'));
            }
        } catch (error) {
            console.error('Error submitting review:', error);
            alert('Failed to submit review. Please try again.');
        }
    }

    function openLightbox(url) {
        document.getElementById('lightboxImg').src = url;
        document.getElementById('lightbox').classList.remove('hidden');
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.add('hidden');
    }

    function viewUserHistory(userId) {
        window.location.href = '/admin/users/' + userId + '/reports';
    }

    function contactReporter() {
        alert('Email functionality will be implemented');
    }

    function contactReported() {
        alert('Email functionality will be implemented');
    }
</script>

<%- include('../partials/footer') %>
