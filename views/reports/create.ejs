<%- include('../partials/header') %>

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-12">
    <div class="container mx-auto px-4">
        <!-- Back Button -->
        <div class="mb-6">
            <button onclick="history.back()" class="flex items-center text-gray-600 hover:text-gray-800 transition">
                <i class="fas fa-arrow-left mr-2"></i>
                Back
            </button>
        </div>

        <div class="max-w-3xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="text-center">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Report an Issue</h1>
                    <p class="text-gray-600">Help us maintain a safe and respectful community</p>
                </div>

                <!-- Context Information -->
                <% if (booking) { %>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="font-semibold text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Booking Information
                        </h3>
                        <p class="text-sm text-blue-800">
                            <strong>Booking Reference:</strong> <%= booking.bookingReference || 'N/A' %>
                        </p>
                        <% if (booking.ride && booking.ride.rider) { %>
                            <p class="text-sm text-blue-800 mt-1">
                                <strong>Rider:</strong> <%= booking.ride.rider.name || booking.ride.rider.profile?.firstName + ' ' + booking.ride.rider.profile?.lastName || 'User' %>
                            </p>
                        <% } %>
                        <% if (booking.passenger) { %>
                            <p class="text-sm text-blue-800 mt-1">
                                <strong>Passenger:</strong> <%= booking.passenger.name || booking.passenger.profile?.firstName + ' ' + booking.passenger.profile?.lastName || 'User' %>
                            </p>
                        <% } %>
                    </div>
                <% } else if (ride) { %>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="font-semibold text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Ride Information
                        </h3>
                        <p class="text-sm text-blue-800">
                            <strong>Ride ID:</strong> <%= ride._id.toString().substring(0, 8) %>...
                        </p>
                        <% if (ride.rider) { %>
                            <p class="text-sm text-blue-800 mt-1">
                                <strong>Rider:</strong> <%= ride.rider.name || ride.rider.profile?.firstName + ' ' + ride.rider.profile?.lastName || 'User' %>
                            </p>
                        <% } %>
                    </div>
                <% } %>
            </div>

            <!-- Report Form -->
            <form id="reportForm" class="bg-white rounded-2xl shadow-lg p-8">
                <% 
                    // Determine who is being reported based on user's role and context
                    let reportedUserObj = null;
                    let reportedUserId = '';
                    
                    if (booking) {
                        // If user is passenger, report the rider
                        // If user is rider, report the passenger
                        if (user._id.toString() === booking.passenger._id.toString()) {
                            reportedUserObj = booking.ride.rider;
                            reportedUserId = booking.ride.rider._id.toString();
                        } else if (booking.ride && user._id.toString() === booking.ride.rider._id.toString()) {
                            reportedUserObj = booking.passenger;
                            reportedUserId = booking.passenger._id.toString();
                        }
                    } else if (ride) {
                        reportedUserObj = ride.rider;
                        reportedUserId = ride.rider._id.toString();
                    } else if (reportedUser) {
                        reportedUserObj = reportedUser;
                        reportedUserId = reportedUser._id.toString();
                    }
                %>
                
                <!-- Hidden Fields -->
                <input type="hidden" name="reportedUserId" id="reportedUserId" value="<%= reportedUserId %>">
                
                <% if (booking) { %>
                    <input type="hidden" name="bookingId" value="<%= booking._id %>">
                <% } %>
                
                <% if (ride) { %>
                    <input type="hidden" name="rideId" value="<%= ride._id %>">
                <% } %>

                <% if (reportedUserObj) { %>
                    <!-- Show who is being reported -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <label class="block text-gray-700 font-semibold mb-3">
                            <i class="fas fa-user text-red-500 mr-2"></i>Reporting:
                        </label>
                        <div class="flex items-center space-x-3">
                            <img src="<%= reportedUserObj.profilePhoto || '/images/default-avatar.png' %>" 
                                alt="User" class="w-12 h-12 rounded-full">
                            <div>
                                <p class="font-semibold text-gray-800">
                                    <%= reportedUserObj.name || (reportedUserObj.profile ? reportedUserObj.profile.firstName + ' ' + reportedUserObj.profile.lastName : 'User') %>
                                </p>
                                <p class="text-sm text-gray-500">
                                    <%= booking ? (user._id.toString() === booking.passenger._id.toString() ? 'Your Driver' : 'Your Passenger') : 'User' %>
                                </p>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <!-- Fallback: Manual user search (should rarely happen) -->
                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-800 text-sm">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Error:</strong> Could not determine who to report. Please go back and try again from your trip history or booking details.
                        </p>
                        <button type="button" onclick="history.back()" class="mt-3 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                            <i class="fas fa-arrow-left mr-2"></i>Go Back
                        </button>
                    </div>
                <% } %>

                <!-- Report Category -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-list text-red-500 mr-2"></i>Report Category *
                    </label>
                    <select name="category" id="category" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        <option value="">-- Select a category --</option>
                        <option value="RECKLESS_DRIVING">üöó Reckless Driving</option>
                        <option value="HARASSMENT">‚ö†Ô∏è Harassment</option>
                        <option value="INAPPROPRIATE_BEHAVIOR">üö´ Inappropriate Behavior</option>
                        <option value="VEHICLE_MISMATCH">üöô Vehicle Mismatch</option>
                        <option value="SMOKING">üö¨ Smoking in Vehicle</option>
                        <option value="UNSAFE_VEHICLE">‚ö†Ô∏è Unsafe Vehicle</option>
                        <option value="ROUTE_DEVIATION">üó∫Ô∏è Route Deviation</option>
                        <option value="OVERCHARGING">üí∞ Overcharging</option>
                        <option value="FAKE_PROFILE">üë§ Fake Profile</option>
                        <option value="NO_SHOW">‚ùå No Show</option>
                        <option value="RUDE_BEHAVIOR">üò† Rude Behavior</option>
                        <option value="VEHICLE_DAMAGE">üîß Vehicle Damage</option>
                        <option value="PAYMENT_DISPUTE">üí≥ Payment Dispute</option>
                        <option value="OTHER">üìù Other</option>
                    </select>
                </div>

                <!-- Severity Level -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>Severity Level *
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="severity" value="LOW" required class="peer sr-only">
                            <div class="p-4 border-2 border-gray-300 rounded-lg text-center peer-checked:border-yellow-500 peer-checked:bg-yellow-50 hover:border-yellow-400 transition">
                                <i class="fas fa-circle text-yellow-500 text-2xl mb-2"></i>
                                <p class="font-semibold text-gray-700">Low</p>
                                <p class="text-xs text-gray-500 mt-1">Minor inconvenience</p>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="severity" value="MEDIUM" required class="peer sr-only">
                            <div class="p-4 border-2 border-gray-300 rounded-lg text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 hover:border-orange-400 transition">
                                <i class="fas fa-circle text-orange-500 text-2xl mb-2"></i>
                                <p class="font-semibold text-gray-700">Medium</p>
                                <p class="text-xs text-gray-500 mt-1">Concerning issue</p>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="severity" value="HIGH" required class="peer sr-only">
                            <div class="p-4 border-2 border-gray-300 rounded-lg text-center peer-checked:border-red-500 peer-checked:bg-red-50 hover:border-red-400 transition">
                                <i class="fas fa-circle text-red-500 text-2xl mb-2"></i>
                                <p class="font-semibold text-gray-700">High</p>
                                <p class="text-xs text-gray-500 mt-1">Serious violation</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-file-alt text-red-500 mr-2"></i>Detailed Description *
                    </label>
                    <textarea name="description" id="description" required
                        minlength="50" maxlength="1000" rows="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"
                        placeholder="Please provide detailed information about what happened. Include specific dates, times, locations, and any other relevant details. (Minimum 50 characters)"></textarea>
                    <div class="flex justify-between text-sm mt-2">
                        <span class="text-gray-500">Minimum 50 characters required</span>
                        <span id="charCount" class="text-gray-500">0 / 1000</span>
                    </div>
                </div>

                <!-- Evidence Upload (Optional) -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-camera text-red-500 mr-2"></i>Evidence (Optional)
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-400 transition">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">Upload screenshots or photos</p>
                        <input type="file" name="evidence" id="evidence" multiple accept="image/*"
                            class="hidden">
                        <label for="evidence" class="inline-block px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg cursor-pointer transition">
                            Choose Files
                        </label>
                        <p class="text-xs text-gray-500 mt-2">Max 5 files, 5MB each</p>
                    </div>
                    <div id="filePreview" class="mt-4 grid grid-cols-3 gap-4"></div>
                </div>

                <!-- Refund Request (for payment disputes) -->
                <div class="mb-6" id="refundSection" style="display: none;">
                    <label class="flex items-center space-x-3 cursor-pointer p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <input type="checkbox" name="requestRefund" id="requestRefund" 
                            class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <div>
                            <span class="font-semibold text-blue-900">
                                <i class="fas fa-undo mr-2"></i>Request a refund
                            </span>
                            <p class="text-sm text-blue-700 mt-1">Our team will review your refund request along with this report</p>
                        </div>
                    </label>
                </div>

                <!-- Important Notice -->
                <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                    <h4 class="font-semibold text-yellow-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Important Notice
                    </h4>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        <li>‚Ä¢ False reports may result in your account suspension</li>
                        <li>‚Ä¢ All reports are reviewed by our team within 24-48 hours</li>
                        <li>‚Ä¢ You'll receive updates via email and notifications</li>
                        <li>‚Ä¢ Provide as much detail as possible for faster resolution</li>
                    </ul>
                </div>

                <!-- Submit Button -->
                <div class="flex space-x-4">
                    <button type="button" onclick="history.back()"
                        class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                        class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Report
                    </button>
                </div>
            </form>

            <!-- Support Information -->
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>Need immediate help? Call our safety hotline: 
                    <a href="tel:+911234567890" class="text-red-600 hover:text-red-700 font-semibold">
                        <i class="fas fa-phone mr-1"></i>+91 123 456 7890
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Character counter
    const descriptionTextarea = document.getElementById('description');
    const charCount = document.getElementById('charCount');

    descriptionTextarea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = `${count} / 1000`;
        
        if (count < 50) {
            charCount.classList.add('text-red-500');
            charCount.classList.remove('text-gray-500');
        } else {
            charCount.classList.remove('text-red-500');
            charCount.classList.add('text-gray-500');
        }
    });

    // Show refund section for payment disputes
    const categorySelect = document.getElementById('category');
    const refundSection = document.getElementById('refundSection');

    categorySelect.addEventListener('change', function() {
        if (this.value === 'PAYMENT_DISPUTE' || this.value === 'OVERCHARGING') {
            refundSection.style.display = 'block';
        } else {
            refundSection.style.display = 'none';
            document.getElementById('requestRefund').checked = false;
        }
    });

    // File preview
    const evidenceInput = document.getElementById('evidence');
    const filePreview = document.getElementById('filePreview');
    let selectedFiles = [];

    evidenceInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        // Limit to 5 files
        if (selectedFiles.length + files.length > 5) {
            alert('Maximum 5 files allowed');
            return;
        }

        files.forEach(file => {
            // Check file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert(`File ${file.name} is too large. Maximum 5MB per file.`);
                return;
            }

            selectedFiles.push(file);

            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.className = 'relative';
                preview.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg">
                    <button type="button" onclick="removeFile('${file.name}')" 
                        class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                filePreview.appendChild(preview);
            };
            reader.readAsDataURL(file);
        });

        // Clear input
        e.target.value = '';
    });

    // Remove file
    window.removeFile = function(fileName) {
        selectedFiles = selectedFiles.filter(f => f.name !== fileName);
        // Rebuild preview
        filePreview.innerHTML = '';
        selectedFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.className = 'relative';
                preview.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg">
                    <button type="button" onclick="removeFile('${file.name}')" 
                        class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                filePreview.appendChild(preview);
            };
            reader.readAsDataURL(file);
        });
    };

    // Form submission
    const reportForm = document.getElementById('reportForm');
    const submitBtn = document.getElementById('submitBtn');

    reportForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Validate
        const reportedUserId = document.getElementById('reportedUserId').value;
        if (!reportedUserId) {
            alert('Please select a user to report');
            return;
        }

        const description = descriptionTextarea.value;
        if (description.length < 50) {
            alert('Description must be at least 50 characters');
            descriptionTextarea.focus();
            return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

        try {
            const formData = new FormData(reportForm);
            
            // Add files
            selectedFiles.forEach((file, index) => {
                formData.append(`evidence`, file);
            });

            const response = await fetch('/reports/create', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                alert('Report submitted successfully! Our team will review it within 24-48 hours.');
                window.location.href = '/user/dashboard';
            } else {
                alert(data.message || 'Failed to submit report. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Report';
            }
        } catch (error) {
            console.error('Report submission error:', error);
            alert('An error occurred. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Report';
        }
    });
</script>

<%- include('../partials/footer') %>
