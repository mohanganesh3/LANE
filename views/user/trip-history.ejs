<%- include('../partials/header') %>

<div class="pt-20 pb-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4">
        <!-- Page Header -->
        <div class="bg-gradient-to-r from-primary to-green-600 rounded-2xl shadow-lg p-8 mb-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-history mr-3"></i>Trip History
                    </h1>
                    <p class="opacity-90">
                        <% if (user.role === 'RIDER') { %>
                            Review your completed rides and passenger feedback
                        <% } else { %>
                            Review your completed bookings and travel history
                        <% } %>
                    </p>
                </div>
                <div class="hidden md:block text-center">
                    <div class="text-4xl font-bold mb-1"><%= pagination.totalItems %></div>
                    <p class="text-sm opacity-90">Completed Trips</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Total Trips</p>
                        <p class="text-3xl font-bold text-gray-800"><%= pagination.totalItems %></p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-route text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">
                            <% if (user.role === 'RIDER') { %>
                                Total Earnings
                            <% } else { %>
                                Total Spent
                            <% } %>
                        </p>
                        <p class="text-3xl font-bold text-primary">
                            ₹<%= trips.reduce((sum, trip) => {
                                if (user.role === 'RIDER') {
                                    return sum + (trip.totalEarnings || 0);
                                } else {
                                    return sum + (trip.totalAmount || 0);
                                }
                            }, 0).toLocaleString() %>
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-rupee-sign text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Average Rating</p>
                        <div class="flex items-center space-x-2">
                            <p class="text-3xl font-bold text-gray-800">
                                <%= (user.rating?.overall || 0).toFixed(1) %>
                            </p>
                            <div class="text-yellow-400">
                                <% for(let i = 1; i <= 5; i++) { %>
                                    <% if(i <= Math.floor(user.rating?.overall || 0)) { %>
                                        <i class="fas fa-star"></i>
                                    <% } else { %>
                                        <i class="far fa-star"></i>
                                    <% } %>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-star text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip History List -->
        <div class="space-y-6">
            <% if (trips.length === 0) { %>
                <!-- Empty State -->
                <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
                    <i class="fas fa-clipboard-list text-gray-300 text-6xl mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No completed trips yet</h3>
                    <p class="text-gray-500 mb-6">
                        <% if (user.role === 'RIDER') { %>
                            Post your first ride to start earning
                        <% } else { %>
                            Book your first ride to start traveling
                        <% } %>
                    </p>
                    <% if (user.role === 'RIDER') { %>
                        <a href="/rides/post" class="inline-block bg-primary hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle mr-2"></i>Post a Ride
                        </a>
                    <% } else { %>
                        <a href="/rides/search" class="inline-block bg-primary hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-search mr-2"></i>Find Rides
                        </a>
                    <% } %>
                </div>
            <% } else { %>
                <!-- Trip Cards -->
                <% trips.forEach(trip => { %>
                    <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition p-6">
                        <% if (user.role === 'RIDER') { %>
                            <!-- Rider View - Posted Ride -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white">
                                        <i class="fas fa-car text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800">Your Ride</h3>
                                        <p class="text-sm text-gray-500">
                                            <%= new Date(trip.departureTime).toLocaleDateString('en-US', { 
                                                weekday: 'short', 
                                                year: 'numeric', 
                                                month: 'short', 
                                                day: 'numeric' 
                                            }) %>
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-primary mb-1">₹<%= trip.totalEarnings || 0 %></div>
                                    <p class="text-sm text-gray-600"><%= trip.bookings?.filter(b => b.status === 'COMPLETED').length || 0 %> passengers</p>
                                </div>
                            </div>

                            <!-- Route -->
                            <div class="border-t border-b py-4 mb-4">
                                <div class="space-y-2">
                                    <div class="flex items-center text-gray-700">
                                        <i class="fas fa-map-marker-alt text-green-600 w-6"></i>
                                        <span class="ml-2 font-medium"><%= trip.from.address %></span>
                                    </div>
                                    <div class="flex items-center text-gray-400 ml-6">
                                        <i class="fas fa-ellipsis-v"></i>
                                        <span class="ml-3 text-sm"><%= trip.distance ? trip.distance.toFixed(1) + ' km' : 'Distance not available' %></span>
                                    </div>
                                    <div class="flex items-center text-gray-700">
                                        <i class="fas fa-map-marker-alt text-red-600 w-6"></i>
                                        <span class="ml-2 font-medium"><%= trip.to.address %></span>
                                    </div>
                                </div>
                                
                                <!-- Carbon Savings Badge -->
                                <% if (trip.carbonSaved && trip.carbonSaved > 0) { %>
                                    <div class="mt-4 p-3 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border border-green-200">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-leaf text-green-600 text-xl"></i>
                                                <div>
                                                    <p class="text-xs text-gray-600 font-medium">Carbon Impact</p>
                                                    <p class="text-lg font-bold text-green-600">
                                                        <%= trip.carbonSaved.toFixed(1) %> kg CO₂ saved
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xs text-gray-600">Equivalent to</p>
                                                <p class="text-sm font-semibold text-green-700">
                                                    🌳 <%= (trip.carbonSaved / 21).toFixed(1) %> trees
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </div>

                            <!-- Passengers -->
                            <% if (trip.bookings && trip.bookings.length > 0) { %>
                                <div class="mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">Passengers on this ride:</h4>
                                    <div class="space-y-2">
                                        <% trip.bookings.forEach(booking => { %>
                                            <% if (booking.status === 'COMPLETED' && booking.passenger) { %>
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <div class="flex items-center space-x-3">
                                                        <img src="<%= booking.passenger.profilePhoto || '/images/default-avatar.png' %>" 
                                                            class="w-10 h-10 rounded-full" 
                                                            alt="<%= booking.passenger.name %>">
                                                        <div>
                                                            <p class="font-medium text-gray-800"><%= booking.passenger.name %></p>
                                                            <div class="flex items-center text-sm text-gray-600">
                                                                <div class="text-yellow-400 mr-1">
                                                                    <% const pRating = booking.passenger.rating?.overall || 0; %>
                                                                    <% for(let i = 1; i <= 5; i++) { %>
                                                                        <% if(i <= Math.floor(pRating)) { %>
                                                                            ★
                                                                        <% } else { %>
                                                                            ☆
                                                                        <% } %>
                                                                    <% } %>
                                                                </div>
                                                                <span><%= pRating.toFixed(1) %></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span class="text-primary font-semibold">₹<%= booking.totalAmount || 0 %></span>
                                                </div>
                                            <% } %>
                                        <% }); %>
                                    </div>
                                </div>
                            <% } %>

                        <% } else { %>
                            <!-- Passenger View - Booked Ride -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <img src="<%= trip.ride?.rider?.profilePhoto || '/images/default-avatar.png' %>" 
                                        class="w-12 h-12 rounded-full" 
                                        alt="<%= trip.ride?.rider?.name %>">
                                    <div>
                                        <h3 class="font-semibold text-gray-800"><%= trip.ride?.rider?.name %></h3>
                                        <div class="flex items-center text-sm text-gray-600">
                                            <div class="text-yellow-400 mr-2">
                                                <% const rRating = trip.ride?.rider?.rating?.overall || 0; %>
                                                <% for(let i = 1; i <= 5; i++) { %>
                                                    <% if(i <= Math.floor(rRating)) { %>
                                                        <i class="fas fa-star"></i>
                                                    <% } else { %>
                                                        <i class="far fa-star"></i>
                                                    <% } %>
                                                <% } %>
                                            </div>
                                            <span><%= rRating.toFixed(1) %></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-primary mb-1">₹<%= trip.totalAmount || 0 %></div>
                                    <p class="text-sm text-gray-600"><%= trip.seatsBooked %> seat(s)</p>
                                </div>
                            </div>

                            <!-- Route -->
                            <div class="border-t border-b py-4 mb-4">
                                <div class="space-y-2">
                                    <div class="flex items-center text-gray-700">
                                        <i class="fas fa-map-marker-alt text-green-600 w-6"></i>
                                        <span class="ml-2 font-medium"><%= trip.ride?.from?.address || 'Not available' %></span>
                                    </div>
                                    <div class="flex items-center text-gray-400 ml-6">
                                        <i class="fas fa-ellipsis-v"></i>
                                        <span class="ml-3 text-sm">
                                            <%= trip.ride?.distance ? trip.ride.distance.toFixed(1) + ' km' : 'Distance not available' %>
                                        </span>
                                    </div>
                                    <div class="flex items-center text-gray-700">
                                        <i class="fas fa-map-marker-alt text-red-600 w-6"></i>
                                        <span class="ml-2 font-medium"><%= trip.ride?.to?.address || 'Not available' %></span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-sm text-gray-600">
                                    <div>
                                        <i class="fas fa-calendar text-primary mr-2"></i>
                                        <%= new Date(trip.ride?.departureTime).toLocaleDateString() %>
                                    </div>
                                    <div>
                                        <i class="fas fa-clock text-primary mr-2"></i>
                                        <%= new Date(trip.ride?.departureTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %>
                                    </div>
                                    <% if (trip.ride?.vehicle) { %>
                                        <div>
                                            <i class="fas fa-car text-primary mr-2"></i>
                                            <%= trip.ride.vehicle.model %>
                                        </div>
                                    <% } %>
                                </div>
                                
                                <!-- Carbon Savings Badge for Passenger -->
                                <% if (trip.carbonSaved && trip.carbonSaved > 0) { %>
                                    <div class="mt-4 p-3 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border border-green-200">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-leaf text-green-600 text-xl"></i>
                                                <div>
                                                    <p class="text-xs text-gray-600 font-medium">Your Carbon Impact</p>
                                                    <p class="text-lg font-bold text-green-600">
                                                        <%= trip.carbonSaved.toFixed(1) %> kg CO₂ saved
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xs text-gray-600">By carpooling</p>
                                                <p class="text-sm font-semibold text-green-700">
                                                    🌍 Eco-friendly choice!
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        <% } %>

                        <!-- Actions -->
                        <div class="flex flex-wrap gap-3">
                            <a href="<%= user.role === 'RIDER' ? '/rides/' + trip._id : '/bookings/' + trip._id %>" 
                                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition text-sm">
                                <i class="fas fa-eye mr-2"></i>View Details
                            </a>

                            <% if (user.role === 'PASSENGER' && !trip.reviews?.passengerReviewed) { %>
                                <a href="/reviews/booking/<%= trip._id %>" 
                                    class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold transition text-sm">
                                    <i class="fas fa-star mr-2"></i>Rate Rider
                                </a>
                            <% } %>

                            <% if (user.role === 'RIDER' && trip.bookings && trip.bookings.length > 0) { %>
                                <button onclick="viewPassengerReviews('<%= trip._id %>')" 
                                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition text-sm">
                                    <i class="fas fa-comment-dots mr-2"></i>View Reviews
                                </button>
                            <% } %>
                        </div>

                        <!-- Trip Date -->
                        <p class="text-gray-400 text-xs mt-4">
                            <i class="fas fa-clock mr-1"></i>
                            Completed on <%= new Date(trip.completedAt || trip.createdAt).toLocaleString() %>
                        </p>
                    </div>
                <% }); %>

                <!-- Pagination -->
                <% if (pagination.totalPages > 1) { %>
                    <div class="flex justify-center items-center space-x-2 mt-8">
                        <% if (pagination.hasPrevPage) { %>
                            <a href="?page=<%= pagination.currentPage - 1 %>" 
                                class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        <% } %>

                        <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                            <% if (i === pagination.currentPage) { %>
                                <span class="px-4 py-2 bg-primary text-white rounded-lg font-semibold">
                                    <%= i %>
                                </span>
                            <% } else if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 1 && i <= pagination.currentPage + 1)) { %>
                                <a href="?page=<%= i %>" 
                                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                    <%= i %>
                                </a>
                            <% } else if (i === pagination.currentPage - 2 || i === pagination.currentPage + 2) { %>
                                <span class="px-4 py-2">...</span>
                            <% } %>
                        <% } %>

                        <% if (pagination.hasNextPage) { %>
                            <a href="?page=<%= pagination.currentPage + 1 %>" 
                                class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        <% } %>
                    </div>
                <% } %>
            <% } %>
        </div>
    </div>
</div>

<script>
function viewPassengerReviews(rideId) {
    // This would open a modal or redirect to a reviews page
    window.location.href = `/rides/${rideId}#reviews`;
}
</script>

<%- include('../partials/footer') %>
