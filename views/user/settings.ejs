<%- include('../partials/header') %>

<div class="pt-20 pb-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">
            <i class="fas fa-cog text-primary mr-3"></i>Settings
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Settings Navigation -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <nav class="space-y-2">
                        <a href="#account" class="flex items-center px-4 py-3 text-primary bg-green-50 rounded-lg font-semibold">
                            <i class="fas fa-user w-6 mr-3"></i>Account
                        </a>
                        <a href="#notifications" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg">
                            <i class="fas fa-bell w-6 mr-3"></i>Notifications
                        </a>
                        <a href="#privacy" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg">
                            <i class="fas fa-shield-alt w-6 mr-3"></i>Privacy & Safety
                        </a>
                        <a href="#preferences" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg">
                            <i class="fas fa-sliders-h w-6 mr-3"></i>Preferences
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Settings Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Account Settings -->
                <div id="account" class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Account Settings</h2>
                    
                    <form id="accountForm" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Email</label>
                            <input type="email" value="<%= user.email %>" disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Phone</label>
                            <input type="tel" value="<%= user.phone %>" disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                        </div>

                        <div class="border-t pt-6">
                            <h3 class="font-semibold text-gray-800 mb-4">Change Password</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Current Password</label>
                                    <input type="password" name="currentPassword" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">New Password</label>
                                    <input type="password" name="newPassword" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Confirm New Password</label>
                                    <input type="password" name="confirmPassword" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-3 bg-primary hover:bg-green-700 text-white rounded-lg transition">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Notification Settings -->
                <div id="notifications" class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Notification Preferences</h2>
                    
                    <form id="notificationForm" class="space-y-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-800">Email Notifications</h4>
                                    <p class="text-sm text-gray-600">Receive updates via email</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-800">SMS Notifications</h4>
                                    <p class="text-sm text-gray-600">Receive updates via SMS</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-800">Booking Notifications</h4>
                                    <p class="text-sm text-gray-600">Get notified about bookings</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-800">Promotional Emails</h4>
                                    <p class="text-sm text-gray-600">Receive offers and updates</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-3 bg-primary hover:bg-green-700 text-white rounded-lg transition">
                                <i class="fas fa-save mr-2"></i>Save Preferences
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Privacy Settings -->
                <div id="privacy" class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Privacy & Safety</h2>
                    
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-gray-800">Profile Visibility</h4>
                                <p class="text-sm text-gray-600">Who can see your profile</p>
                            </div>
                            <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                <option>Everyone</option>
                                <option>Verified Users Only</option>
                                <option>Connections Only</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-gray-800">Show Phone Number</h4>
                                <p class="text-sm text-gray-600">Display phone after booking</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>

                        <div class="border-t pt-6">
                            <h3 class="font-semibold text-red-600 mb-4 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Danger Zone
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Once you delete your account, there is no going back. Please be certain.
                            </p>
                            <div class="space-y-3">
                                <button id="deleteAccountBtn" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold flex items-center justify-center">
                                    <i class="fas fa-trash-alt mr-2"></i>Delete My Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
        <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-trash-alt text-red-600 text-2xl"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-800">Delete Account</h3>
                <p class="text-sm text-gray-500">Permanent action</p>
            </div>
        </div>
        
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
            <p class="text-sm text-red-800 font-semibold">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                This action CANNOT be undone!
            </p>
        </div>

        <div class="space-y-3 mb-6">
            <h4 class="font-semibold text-gray-700 text-sm">What will be deleted:</h4>
            <ul class="text-sm text-gray-600 space-y-2">
                <li class="flex items-start">
                    <i class="fas fa-times text-red-500 mr-2 mt-1"></i>
                    <span>Your profile and personal information</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-times text-red-500 mr-2 mt-1"></i>
                    <span>All rides and booking history</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-times text-red-500 mr-2 mt-1"></i>
                    <span>Reviews and ratings</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-times text-red-500 mr-2 mt-1"></i>
                    <span>Chat messages and notifications</span>
                </li>
            </ul>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Type <strong>DELETE</strong> to confirm:
            </label>
            <input type="text" id="deleteConfirmText" 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                placeholder="Type DELETE here">
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Why are you leaving? (Optional)
            </label>
            <select id="deleteReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                <option value="">Select a reason...</option>
                <option value="found_alternative">Found an alternative</option>
                <option value="bad_experience">Bad experience</option>
                <option value="privacy_concerns">Privacy concerns</option>
                <option value="safety_concerns">Safety concerns</option>
                <option value="not_using">Not using the app anymore</option>
                <option value="other">Other reason</option>
            </select>
        </div>

        <div class="flex space-x-3">
            <button id="cancelDelete" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-semibold">
                Cancel
            </button>
            <button id="confirmDelete" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Delete Forever
            </button>
        </div>
    </div>
</div>

<script>
document.getElementById('accountForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    if (data.newPassword && data.newPassword !== data.confirmPassword) {
        LANEApp.showAlert('Passwords do not match', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/users/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            LANEApp.showAlert('Password changed successfully', 'success');
            e.target.reset();
        } else {
            const error = await response.json();
            LANEApp.showAlert(error.message || 'Failed to change password', 'error');
        }
    } catch (error) {
        LANEApp.showAlert('Failed to change password', 'error');
    }
});

document.getElementById('notificationForm').addEventListener('submit', (e) => {
    e.preventDefault();
    LANEApp.showAlert('Notification preferences saved', 'success');
});

// ============================================
// DELETE ACCOUNT FUNCTIONALITY
// ============================================
const deleteAccountBtn = document.getElementById('deleteAccountBtn');
const deleteModal = document.getElementById('deleteModal');
const cancelDelete = document.getElementById('cancelDelete');
const confirmDelete = document.getElementById('confirmDelete');
const deleteConfirmText = document.getElementById('deleteConfirmText');
const deleteReason = document.getElementById('deleteReason');

deleteAccountBtn?.addEventListener('click', () => {
    deleteModal.classList.remove('hidden');
});

cancelDelete?.addEventListener('click', () => {
    deleteModal.classList.add('hidden');
    deleteConfirmText.value = '';
    deleteReason.value = '';
    confirmDelete.disabled = true;
});

// Enable delete button only when user types DELETE
deleteConfirmText?.addEventListener('input', (e) => {
    confirmDelete.disabled = e.target.value.trim() !== 'DELETE';
});

confirmDelete?.addEventListener('click', async () => {
    const reason = deleteReason.value;
    
    if (deleteConfirmText.value !== 'DELETE') {
        LANEApp.showAlert('⚠️ Please type DELETE to confirm', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/users/account', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        });

        const result = await response.json();

        if (result.success) {
            LANEApp.showAlert('✅ Account deleted successfully. We\'re sorry to see you go.', 'success');
            setTimeout(() => {
                window.location.href = result.redirectUrl || '/';
            }, 2000);
        } else {
            LANEApp.showAlert(result.message || 'Failed to delete account', 'error');
        }
    } catch (error) {
        console.error('Delete error:', error);
        LANEApp.showAlert('❌ Unable to delete account. Please try again.', 'error');
    }
});

// Close modal when clicking outside
deleteModal?.addEventListener('click', (e) => {
    if (e.target === deleteModal) {
        deleteModal.classList.add('hidden');
    }
});
</script>

<%- include('../partials/footer') %>
